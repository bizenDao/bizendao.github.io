<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BizenDAO - EOAÁôªÈå≤</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>
    <script src="../js/config.js"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/nft.js"></script>
    <script src="../js/wallet.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/lang-toggle.js"></script>

    <style>
      main {
        padding-top: 100px;
        min-height: 100vh;
      }

      .regist-page {
        max-width: 560px;
        margin: 0 auto;
        padding: 5px 20px 60px;
      }

      .page-title {
        font-size: 28px;
        margin-bottom: 12px;
        font-family: "Times New Roman", "Hiragino Mincho ProN", serif;
      }

      .page-desc {
        font-size: 14px;
        opacity: 0.7;
        margin-bottom: 32px;
        line-height: 1.7;
      }

      .btn {
        padding: 12px 24px;
        border: 1px solid rgba(255,255,255,0.3);
        background: transparent;
        color: #f6f6f6;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:hover { background: rgba(255,255,255,0.1); }
      .btn:disabled { opacity: 0.4; cursor: not-allowed; }

      .btn-connect {
        display: block;
        width: 100%;
        padding: 16px;
        font-size: 16px;
        background: rgba(255,255,255,0.06);
        margin-bottom: 24px;
      }

      .btn-primary {
        background: rgba(88,101,242,0.15);
        border-color: rgba(88,101,242,0.4);
        padding: 14px 32px;
        font-size: 15px;
      }

      .btn-primary:hover:not(:disabled) {
        background: rgba(88,101,242,0.25);
      }

      .section-card {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .section-card h2 {
        font-size: 18px;
        margin-bottom: 16px;
      }

      .form-field {
        margin-bottom: 16px;
      }

      .form-field label {
        display: block;
        font-size: 13px;
        opacity: 0.6;
        margin-bottom: 6px;
      }

      .form-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.05);
        color: #f6f6f6;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        font-family: monospace;
      }

      .form-input:focus {
        outline: none;
        border-color: rgba(255,255,255,0.4);
        background: rgba(255,255,255,0.08);
      }

      .form-input:disabled {
        opacity: 0.5;
      }

      .wallet-display {
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        margin-bottom: 20px;
        word-break: break-all;
      }

      .error-message {
        padding: 12px 16px;
        background: rgba(255,0,0,0.1);
        border: 1px solid rgba(255,0,0,0.3);
        border-radius: 6px;
        color: #ff6666;
        font-size: 13px;
        margin-bottom: 16px;
      }

      .success-card {
        padding: 24px;
        background: rgba(0,255,100,0.08);
        border: 1px solid rgba(0,255,100,0.25);
        border-radius: 10px;
        text-align: center;
        margin-bottom: 24px;
      }

      .success-card h3 { color: #66ff99; margin-bottom: 8px; }

      .connect-prompt {
        text-align: center;
        padding: 60px 20px;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      .hint {
        font-size: 12px;
        opacity: 0.5;
        margin-top: 6px;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header class="site-header">
        <div class="container header-inner">
          <a href="../ja/index.html" class="logo"><img src="../img/349F5603-389E-48C6-81C9-1515A338A59B.png" alt="„É≠„Ç¥"></a>
        </div>
      </header>

      <main>
        <div class="regist-page">
          <h1 class="page-title">Regist EOA</h1>
          <p class="page-desc">
            Discord„Ç¢„Ç´„Ç¶„É≥„Éà„Å®„Ç¶„Ç©„É¨„ÉÉ„Éà„Ç¢„Éâ„É¨„Çπ„ÇíÁ¥ê‰ªò„Åë„Åæ„Åô„ÄÇ<br>
            Discord„Åß <strong>/regist</strong> „Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å„Åó„Å¶ÂèñÂæó„Åó„ÅüSECRET„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </p>

          <!-- Êú™Êé•Á∂ö -->
          <div v-if="!connected" class="connect-prompt">
            <button v-if="metamaskAvailable" class="btn btn-connect" @click="connectWallet" :disabled="connecting">
              {{ connecting ? 'Êé•Á∂ö‰∏≠...' : 'ü¶ä „Ç¶„Ç©„É¨„ÉÉ„Éà„ÇíÊé•Á∂ö' }}
            </button>
            <p v-else style="opacity:0.5;">{{ t('no_metamask') }}</p>
          </div>

          <!-- Êé•Á∂öÊ∏à„Åø -->
          <template v-else>
            <div v-if="error" class="error-message">{{ error }}</div>

            <!-- ÁôªÈå≤ÂÆå‰∫Ü -->
            <div v-if="registered" class="success-card">
              <h3 data-i18n="register_done">‚úÖ ÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü</h3>
              <p style="opacity:0.7;" data-i18n="register_linked">„Ç¶„Ç©„É¨„ÉÉ„Éà„Å®Discord„ÅåÁ¥ê‰ªò„Åë„Çâ„Çå„Åæ„Åó„Åü„ÄÇ</p>
              <a href="../ja/index.html" class="btn" style="margin-top:12px;" data-i18n="back_to_top">„Éà„ÉÉ„Éó„Å∏Êàª„Çã</a>
            </div>

            <!-- ÁôªÈå≤„Éï„Ç©„Éº„É† -->
            <div v-else class="section-card">
              <h2 data-i18n="register_title">„Ç¶„Ç©„É¨„ÉÉ„ÉàÈÄ£Êê∫</h2>

              <div class="wallet-display">ü¶ä {{ address }}</div>

              <div class="form-field">
                <label>Discord ID</label>
                <input type="text" v-model="discordId" class="form-input" placeholder="123456789012345678"
                       :disabled="discordIdFromUrl" />
                <p class="hint" data-i18n="regist_discord_id">Discord„ÅÆ /regist „Ç≥„Éû„É≥„Éâ„ÅßË°®Á§∫„Åï„Çå„ÅüID</p>
              </div>

              <div class="form-field">
                <label>SECRET</label>
                <input type="text" v-model="secret" class="form-input" placeholder="SECRET„Ç≥„Éº„Éâ" />
                <p class="hint" data-i18n="regist_secret">Discord„ÅÆ /regist „Ç≥„Éû„É≥„Éâ„ÅßË°®Á§∫„Åï„Çå„ÅüSECRET„Ç≥„Éº„Éâ</p>
              </div>

              <button class="btn btn-primary" @click="executeRegist"
                      :disabled="!discordId || !secret || sending" style="margin-top: 8px;">
                <span v-if="sending"><span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> {{ t('registering') }}</span>
                <span v-else>REGIST</span>
              </button>
            </div>
          </template>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            connected: false,
            connecting: false,
            sending: false,
            error: null,
            address: null,
            discordId: '',
            secret: '',
            discordIdFromUrl: false,
            registered: false,
          };
        },
        computed: {
          metamaskAvailable() { return Wallet.isAvailable(); },
          lang() { return window.i18n ? window.i18n.lang() : 'ja'; },
          contentBase() { return window.i18n ? window.i18n.contentBase() : '../ja'; },
        },
        async mounted() {
          // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÂèñÂæó: /regist/?discord=xxx&secret=yyy
          // „Åæ„Åü„ÅØÊóßÂΩ¢ÂºèÂØæÂøú: „Éë„Çπ„Åã„Çâ /regist/:discordId/:secret
          const params = new URLSearchParams(window.location.search);
          if (params.get('discord')) {
            this.discordId = params.get('discord');
            this.discordIdFromUrl = true;
          }
          if (params.get('secret')) {
            this.secret = params.get('secret');
          }

          // „Éè„ÉÉ„Ç∑„É•„Éï„É©„Ç∞„É°„É≥„Éà„Åã„Çâ„ÇÇÂØæÂøú: #discordId/secret
          const hash = window.location.hash.replace('#', '');
          if (hash && hash.includes('/')) {
            const parts = hash.split('/');
            if (parts[0] && !this.discordId) {
              this.discordId = parts[0];
              this.discordIdFromUrl = true;
            }
            if (parts[1] && !this.secret) {
              this.secret = parts[1];
            }
          }

          const r = await Wallet.reconnect();
          if (r) {
            this.address = r.address;
            this.connected = true;
            await Wallet.ensurePolygon();
          }
          if (window.i18n) { window.i18n.apply(); }
          // Update dapp-internal links with lang param
          document.querySelectorAll('a[data-dapp]').forEach(a => {
            if (window.i18n) a.href = window.i18n.dappLink(a.getAttribute('data-dapp'));
          });
        },
        methods: {
          t(key) { return window.i18n ? window.i18n.t(key) : key; },

          async connectWallet() {
            this.connecting = true; this.error = null;
            try {
              const { address } = await Wallet.connect();
              await Wallet.ensurePolygon();
              this.address = address;
              this.connected = true;
            } catch (e) { this.error = e.message; }
            this.connecting = false;
          },

          async executeRegist() {
            this.sending = true; this.error = null;
            try {
              const res = await fetch(CONFIG.botApi + 'regist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  eoa: this.address,
                  discordId: this.discordId,
                  secret: this.secret,
                }),
              });
              const result = await res.json();
              console.log('regist result:', result);

              if (result.result) {
                this.registered = true;
              } else {
                this.error = result.message || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
              }
            } catch (e) {
              this.error = 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message;
            }
            this.sending = false;
          },
        },
      }).mount('#app');
    </script>
</body>
</html>
