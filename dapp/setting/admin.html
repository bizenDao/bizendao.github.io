<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BizenDAO - Admin Settings</title>
    <link rel="stylesheet" href="../../css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>
    <script src="../../js/config.js"></script>
    <script src="../../js/cache.js"></script>
    <script src="../../js/nft.js"></script>
    <script src="../../js/wallet.js"></script>
    <script src="../../js/manager.js"></script>
    <script src="../../js/wallet-header.js"></script>
    <script src="../../js/i18n.js"></script>
    <script src="../../js/lang-toggle.js"></script>
    <link rel="stylesheet" href="setting.css" />
  </head>
  <body>
    <div id="app">
      <header class="site-header">
        <div class="container header-inner">
          <a :href="homeUrl" class="logo"><img src="../../img/349F5603-389E-48C6-81C9-1515A338A59B.png" :alt="t('logo_alt')"></a>
          <div class="header-right">
            <span class="lang-switch"><a class="lang-btn" data-lang="en" href="#">EN</a> / <a class="lang-btn" data-lang="ja" href="#">JP</a></span>
            <button class="nav-toggle" type="button" :aria-label="t('toggle_menu')" @click="toggleMenu">
              <span></span><span></span>
            </button>
          </div>
        </div>
        <div class="nav-overlay" :class="{ 'is-open': menuOpen }" @click="closeMenu"></div>
        <aside class="nav-drawer" :class="{ 'is-open': menuOpen }" :aria-label="t('site_menu')">
          <ul class="drawer-nav">
            <li><a href="#" data-nav="top">{{ t('nav_top') }}</a></li>
            <li><a href="#" data-nav="artists">{{ t('nav_artists') }}</a></li>
            <li><a href="#" data-nav="company">{{ t('nav_company') }}</a></li>
            <li><a href="#" data-nav="discord">{{ t('nav_discord') }}</a></li>
            <li><a href="#" data-nav="meta">{{ t('nav_meta') }}</a></li>
            <li><a href="#" data-dapp="../donation.html">{{ t('nav_donate') }}</a></li>
            <li><a href="#" data-dapp="../account.html">{{ t('nav_mypage') }}</a></li>
          </ul>
        </aside>
      </header>

      <main>
        <div class="setting-page">
          <h1 class="setting-title">{{ t('setting_admin') }}</h1>

          <!-- Setting Nav -->
          <nav class="setting-nav">
            <a :href="'admin.html?lang=' + lang" class="setting-nav-item active">{{ t('setting_admin') }}</a>
            <a :href="'creator.html?lang=' + lang" class="setting-nav-item">{{ t('setting_creator') }}</a>
            <a :href="'contract.html?lang=' + lang" class="setting-nav-item">{{ t('setting_contract') }}</a>
            <a :href="'index.html?lang=' + lang" class="setting-nav-item">{{ t('setting_proxy_donate') }}</a>
          </nav>

          <!-- 未接続 -->
          <div v-if="!connected" class="connect-prompt">
            <button v-if="metamaskAvailable" class="btn btn-connect" @click="connectWallet" :disabled="connecting">
              {{ connecting ? t('connecting') : t('connect_wallet') }}
            </button>
            <p v-else>{{ t('no_metamask') }}</p>
          </div>

          <!-- 権限なし -->
          <div v-else-if="userType !== 'admin'" class="access-denied">
            <p>{{ t('admin_only') }} ({{ userType }})</p>
            <p class="wallet-info-small">{{ shortAddress }}</p>
          </div>

          <!-- Admin管理 -->
          <template v-else>
            <wallet-header :address="address" :user-type="userType" setting-base="index.html"></wallet-header>

            <div v-if="error" class="error-message">{{ error }}</div>
            <div v-if="success" class="success-message">{{ success }}</div>

            <!-- 管理者一覧 -->
            <div class="section-card">
              <h2 class="section-heading">{{ t('admin_list') }}</h2>
              <div v-if="loading" class="loading-center"><span class="loading-spinner"></span></div>
              <table v-else class="data-table">
                <thead>
                  <tr><th>{{ t('address') }}</th><th></th></tr>
                </thead>
                <tbody>
                  <tr v-for="addr in admins" :key="addr">
                    <td class="mono">{{ addr }}</td>
                    <td class="actions">
                      <button class="btn btn-sm btn-danger" @click="removeAdmin(addr)" :disabled="sending">{{ t('remove') }}</button>
                    </td>
                  </tr>
                  <tr v-if="admins.length === 0"><td colspan="2" class="empty">{{ t('no_admins') }}</td></tr>
                </tbody>
              </table>
            </div>

            <!-- 追加フォーム -->
            <div class="section-card">
              <h2 class="section-heading">{{ t('add_admin') }}</h2>
              <div class="form-row">
                <input type="text" v-model="newAdmin" class="form-input mono" placeholder="0x..." />
                <button class="btn btn-primary" @click="addAdmin" :disabled="!newAdmin || sending">{{ t('add') }}</button>
              </div>
            </div>

            <div class="manager-info">
              Manager: <a :href="CONFIG.chain.explorer + '/address/' + CONFIG.contracts.manager.address" target="_blank" class="mono link">{{ CONFIG.contracts.manager.address }}</a>
            </div>
          </template>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            connected: false, connecting: false, sending: false, loading: false,
            error: null, success: null,
            address: null,
            userType: 'none',
            admins: [],
            newAdmin: '',
            menuOpen: false,
            CONFIG,
          };
        },
        computed: {
          homeUrl() { return (window.i18n ? window.i18n.contentBase() : "../../ja") + "/index.html"; },
          metamaskAvailable() { return Wallet.isAvailable(); },
          shortAddress() { return Wallet.shortAddress(); },
          lang() { return (window.i18n && window.i18n.currentLang) || new URLSearchParams(location.search).get('lang') || 'ja'; },
        },
        async mounted() {
          const r = await Wallet.reconnect();
          if (r) { this.connected = true; this.address = Wallet.getAddress(); await this.init(); }
          if (window.i18n) { window.i18n.apply(); }
        },
        methods: {
          t(key) { return window.i18n ? window.i18n.t(key) : key; },
          toggleMenu() { this.menuOpen = !this.menuOpen; document.body.style.overflow = this.menuOpen ? 'hidden' : ''; },
          closeMenu() { this.menuOpen = false; document.body.style.overflow = ''; },
          async connectWallet() {
            this.connecting = true;
            try {
              await Wallet.connect();
              await Wallet.ensurePolygon();
              this.connected = true;
              this.address = Wallet.getAddress();
              await this.init();
            } catch (e) { this.error = e.message; }
            this.connecting = false;
          },
          async init() {
            this.loading = true;
            this.userType = await Manager.checkUser();
            if (this.userType === 'admin') {
              this.admins = await Manager.getAdmins();
            }
            this.loading = false;
          },
          async addAdmin() {
            this.sending = true; this.error = null; this.success = null;
            try {
              await Manager.setAdmin(this.newAdmin);
              this.success = this.t('admin_added');
              this.newAdmin = '';
              this.admins = await Manager.getAdmins();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
          async removeAdmin(addr) {
            if (!confirm(addr + this.t('confirm_remove_admin'))) return;
            this.sending = true; this.error = null; this.success = null;
            try {
              await Manager.delAdmin(addr);
              this.success = this.t('admin_removed');
              this.admins = await Manager.getAdmins();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
        },
      }).component('wallet-header', WalletHeader).mount('#app');
    </script>
</body>
</html>
