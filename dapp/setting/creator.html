<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BizenDAO - Creator Settings</title>
    <link rel="stylesheet" href="../../css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>
    <script src="../../js/config.js"></script>
    <script src="../../js/cache.js"></script>
    <script src="../../js/nft.js"></script>
    <script src="../../js/wallet.js"></script>
    <script src="../../js/manager.js"></script>
    <script src="../../js/wallet-header.js"></script>
    <script src="../../js/i18n.js"></script>
    <script src="../../js/lang-toggle.js"></script>
    <link rel="stylesheet" href="setting.css" />
    <style>
      .name-preview {
        display: block;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 13px;
        font-family: monospace;
        color: rgba(255, 255, 255, 0.6);
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header class="site-header">
        <div class="container header-inner">
          <a href="../../ja/index.html" class="logo"><img src="../../img/349F5603-389E-48C6-81C9-1515A338A59B.png" :alt="t('logo_alt')"></a>
          <div class="header-right">
            <span class="lang-switch"><a class="lang-btn" data-lang="en" href="#">EN</a> / <a class="lang-btn" data-lang="ja" href="#">JP</a></span>
            <button class="nav-toggle" type="button" :aria-label="t('toggle_menu')" @click="toggleMenu">
              <span></span><span></span>
            </button>
          </div>
        </div>
        <div class="nav-overlay" :class="{ 'is-open': menuOpen }" @click="closeMenu"></div>
        <aside class="nav-drawer" :class="{ 'is-open': menuOpen }" :aria-label="t('site_menu')">
          <ul class="drawer-nav">
            <li><a href="#" data-nav="top">{{ t('nav_top') }}</a></li>
            <li><a href="#" data-nav="artists">{{ t('nav_artists') }}</a></li>
            <li><a href="#" data-nav="company">{{ t('nav_company') }}</a></li>
            <li><a href="#" data-nav="discord">{{ t('nav_discord') }}</a></li>
            <li><a href="#" data-nav="meta">{{ t('nav_meta') }}</a></li>
            <li><a href="#" data-dapp="../donation.html">{{ t('nav_donate') }}</a></li>
            <li><a href="#" data-dapp="../account.html">{{ t('nav_mypage') }}</a></li>
          </ul>
        </aside>
      </header>

      <main>
        <div class="setting-page">
          <h1 class="setting-title">{{ t('setting_creator') }}</h1>

          <nav class="setting-nav">
            <a href="admin.html" class="setting-nav-item">{{ t('setting_admin') }}</a>
            <a href="creator.html" class="setting-nav-item active">{{ t('setting_creator') }}</a>
            <a href="contract.html" class="setting-nav-item">{{ t('setting_contract') }}</a>
            <a href="index.html" class="setting-nav-item">{{ t('setting_proxy_donate') }}</a>
          </nav>

          <div v-if="!connected" class="connect-prompt">
            <button v-if="metamaskAvailable" class="btn btn-connect" @click="connectWallet" :disabled="connecting">
              {{ connecting ? t('connecting') : t('connect_wallet') }}
            </button>
            <p v-else>{{ t('no_metamask') }}</p>
          </div>

          <div v-else-if="userType !== 'admin'" class="access-denied">
            <p>{{ t('admin_only') }} ({{ userType }})</p>
            <p class="wallet-info-small">{{ shortAddress }}</p>
          </div>

          <template v-else>
            <wallet-header :address="address" :user-type="userType" setting-base="index.html"></wallet-header>

            <div v-if="error" class="error-message">{{ error }}</div>
            <div v-if="success" class="success-message">{{ success }}</div>

            <!-- 作家一覧 -->
            <div class="section-card">
              <h2 class="section-heading">{{ t('creator_list') }}</h2>
              <div v-if="loading" class="loading-center"><span class="loading-spinner"></span></div>
              <table v-else class="data-table">
                <thead>
                  <tr><th>{{ t('address') }}</th><th>{{ t('name') }}</th><th>{{ t('type') }}</th><th>{{ t('visibility') }}</th><th></th></tr>
                </thead>
                <tbody>
                  <tr v-for="c in creators" :key="c.address" :class="{ 'row-hidden': !c.visible }">
                    <td class="mono addr-cell">{{ shortAddr(c.address) }}</td>
                    <td>{{ displayName(c.name) }}</td>
                    <td>{{ c.type }}</td>
                    <td>
                      <span v-if="c.visible" class="badge-visible">{{ t('visible') }}</span>
                      <span v-else class="badge-hidden">{{ t('hidden') }}</span>
                    </td>
                    <td class="actions">
                      <button v-if="c.visible" class="btn btn-sm" @click="toggleCreator(c, false)" :disabled="sending">{{ t('hidden') }}</button>
                      <button v-else class="btn btn-sm" @click="toggleCreator(c, true)" :disabled="sending">{{ t('visible') }}</button>
                      <button class="btn btn-sm btn-danger" @click="removeCreator(c)" :disabled="sending">{{ t('remove') }}</button>
                    </td>
                  </tr>
                  <tr v-if="creators.length === 0"><td colspan="5" class="empty">{{ t('no_creators') }}</td></tr>
                </tbody>
              </table>
            </div>

            <!-- 追加 / 編集 -->
            <div class="section-card">
              <h2 class="section-heading">{{ editMode ? t('edit_creator') : t('add_creator') }}</h2>
              <div class="form-grid">
                <div class="form-field">
                  <label>{{ t('address') }}</label>
                  <input type="text" v-model="form.address" class="form-input mono" placeholder="0x..." :disabled="editMode" />
                </div>
                <div class="form-field">
                  <label>{{ t('name_ja') }}</label>
                  <input type="text" v-model="form.nameJa" class="form-input" :placeholder="t('name_ja')" />
                </div>
                <div class="form-field">
                  <label>{{ t('name_en') }}</label>
                  <input type="text" v-model="form.nameEn" class="form-input" :placeholder="t('name_en')" />
                </div>
                <div class="form-field" style="grid-column: 1 / -1;">
                  <label>{{ t('preview') }}</label>
                  <code class="name-preview">{{ nameJson }}</code>
                </div>
                <div class="form-field">
                  <label>{{ t('type') }}</label>
                  <input type="text" v-model="form.type" class="form-input" placeholder="creator" />
                </div>
              </div>
              <div class="form-actions">
                <button class="btn btn-primary" @click="submitCreator" :disabled="!form.address || (!form.nameJa && !form.nameEn) || sending">
                  {{ editMode ? t('save') : t('add') }}
                </button>
                <button v-if="editMode" class="btn" @click="cancelEdit">{{ t('cancel') }}</button>
              </div>
            </div>

            <div class="manager-info">
              Manager: <a :href="CONFIG.chain.explorer + '/address/' + CONFIG.contracts.manager.address" target="_blank" class="mono link">{{ CONFIG.contracts.manager.address }}</a>
            </div>
          </template>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            connected: false, connecting: false, sending: false, loading: false,
            error: null, success: null,
            address: null,
            userType: 'none',
            creators: [],
            form: { address: '', nameJa: '', nameEn: '', type: 'creator' },
            editMode: false,
            menuOpen: false,
            CONFIG,
          };
        },
        computed: {
          metamaskAvailable() { return Wallet.isAvailable(); },
          shortAddress() { return Wallet.shortAddress(); },
          nameJson() {
            return JSON.stringify({ en: this.form.nameEn || '', ja: this.form.nameJa || '' });
          },
        },
        async mounted() {
          const r = await Wallet.reconnect();
          if (r) { this.connected = true; this.address = Wallet.getAddress(); await this.init(); }
          if (window.i18n) { window.i18n.apply(); }
        },
        methods: {
          t(key) { return window.i18n ? window.i18n.t(key) : key; },
          toggleMenu() { this.menuOpen = !this.menuOpen; document.body.style.overflow = this.menuOpen ? 'hidden' : ''; },
          closeMenu() { this.menuOpen = false; document.body.style.overflow = ''; },
          async connectWallet() {
            this.connecting = true;
            try {
              await Wallet.connect();
              await Wallet.ensurePolygon();
              this.connected = true;
              this.address = Wallet.getAddress();
              await this.init();
            } catch (e) { this.error = e.message; }
            this.connecting = false;
          },
          async init() {
            this.loading = true;
            this.userType = await Manager.checkUser();
            if (this.userType === 'admin') {
              this.creators = await Manager.getAllCreators();
            }
            this.loading = false;
          },
          shortAddr(a) { return a ? a.slice(0,6) + '...' + a.slice(-4) : ''; },
          parseName(name) {
            try {
              const obj = JSON.parse(name);
              return obj;
            } catch (e) {
              return { ja: name, en: name };
            }
          },
          displayName(name) {
            const p = this.parseName(name);
            return p.ja || p.en || name;
          },
          startEdit(c) {
            const p = this.parseName(c.name);
            this.form = { address: c.address, nameJa: p.ja || '', nameEn: p.en || '', type: c.type };
            this.editMode = true;
          },
          cancelEdit() {
            this.form = { address: '', nameJa: '', nameEn: '', type: 'creator' };
            this.editMode = false;
          },
          async submitCreator() {
            this.sending = true; this.error = null; this.success = null;
            try {
              if (this.editMode) {
                await Manager.setCreatorInfo(this.form.address, this.nameJson, this.form.type);
                this.success = this.t('creator_updated');
              } else {
                await Manager.setCreator(this.form.address, this.nameJson, this.form.type);
                this.success = this.t('creator_added');
              }
              this.cancelEdit();
              this.creators = await Manager.getAllCreators();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
          async toggleCreator(c, visible) {
            this.sending = true; this.error = null; this.success = null;
            try {
              if (visible) { await Manager.publicCreator(c.address); }
              else { await Manager.hiddenCreator(c.address); }
              this.success = visible ? this.t('creator_visible') : this.t('creator_hidden');
              this.creators = await Manager.getAllCreators();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
          async removeCreator(c) {
            if (!confirm(c.name + ' (' + c.address + ')' + this.t('confirm_remove_creator'))) return;
            this.sending = true; this.error = null; this.success = null;
            try {
              await Manager.delCreator(c.address);
              this.success = this.t('creator_removed');
              this.creators = await Manager.getAllCreators();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
        },
      }).component('wallet-header', WalletHeader).mount('#app');
    </script>
</body>
</html>
