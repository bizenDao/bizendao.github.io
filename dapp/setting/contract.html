<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BizenDAO - Contract Settings</title>
    <link rel="stylesheet" href="../../css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>
    <script src="../../js/config.js"></script>
    <script src="../../js/cache.js"></script>
    <script src="../../js/nft.js"></script>
    <script src="../../js/wallet.js"></script>
    <script src="../../js/manager.js"></script>
    <script src="../../js/wallet-header.js"></script>
    <script src="../../js/i18n.js"></script>
    <script src="../../js/lang-toggle.js"></script>
    <link rel="stylesheet" href="setting.css" />
    <style>
      .diff-alert {
        margin-bottom: 24px;
        padding: 16px 20px;
        background: rgba(255, 165, 0, 0.08);
        border: 1px solid rgba(255, 165, 0, 0.3);
        border-radius: 10px;
      }

      .diff-alert h3 {
        font-size: 15px;
        color: #ffaa33;
        margin-bottom: 12px;
      }

      .diff-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 13px;
        flex-wrap: wrap;
      }

      .diff-item:last-child { border-bottom: none; }

      .diff-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
      }

      .diff-badge.config_only {
        background: rgba(107, 182, 255, 0.15);
        color: #6bb6ff;
      }

      .diff-badge.manager_only {
        background: rgba(255, 107, 107, 0.15);
        color: #ff6b6b;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header class="site-header">
        <div class="container header-inner">
          <a :href="homeUrl" class="logo"><img src="../../img/349F5603-389E-48C6-81C9-1515A338A59B.png" :alt="t('logo_alt')"></a>
          <div class="header-right">
            <span class="lang-switch"><a class="lang-btn" data-lang="en" href="#">EN</a> / <a class="lang-btn" data-lang="ja" href="#">JP</a></span>
            <button class="nav-toggle" type="button" :aria-label="t('toggle_menu')" @click="toggleMenu">
              <span></span><span></span>
            </button>
          </div>
        </div>
        <div class="nav-overlay" :class="{ 'is-open': menuOpen }" @click="closeMenu"></div>
        <aside class="nav-drawer" :class="{ 'is-open': menuOpen }" :aria-label="t('site_menu')">
          <ul class="drawer-nav">
            <li><a href="#" data-nav="top">{{ t('nav_top') }}</a></li>
            <li><a href="#" data-nav="artists">{{ t('nav_artists') }}</a></li>
            <li><a href="#" data-nav="company">{{ t('nav_company') }}</a></li>
            <li><a href="#" data-nav="discord">{{ t('nav_discord') }}</a></li>
            <li><a href="#" data-nav="meta">{{ t('nav_meta') }}</a></li>
            <li><a href="#" data-dapp="../donation.html">{{ t('nav_donate') }}</a></li>
            <li><a href="#" data-dapp="../account.html">{{ t('nav_mypage') }}</a></li>
          </ul>
        </aside>
      </header>

      <main>
        <div class="setting-page">
          <h1 class="setting-title">{{ t('setting_contract') }}</h1>

          <nav class="setting-nav">
            <a :href="'admin.html?lang=' + lang" class="setting-nav-item">{{ t('setting_admin') }}</a>
            <a :href="'creator.html?lang=' + lang" class="setting-nav-item">{{ t('setting_creator') }}</a>
            <a :href="'contract.html?lang=' + lang" class="setting-nav-item active">{{ t('setting_contract') }}</a>
            <a :href="'index.html?lang=' + lang" class="setting-nav-item">{{ t('setting_proxy_donate') }}</a>
          </nav>

          <div v-if="!connected" class="connect-prompt">
            <button v-if="metamaskAvailable" class="btn btn-connect" @click="connectWallet" :disabled="connecting">
              {{ connecting ? t('connecting') : t('connect_wallet') }}
            </button>
            <p v-else>{{ t('no_metamask') }}</p>
          </div>

          <div v-else-if="loading" class="loading-center"><span class="loading-spinner"></span></div>

          <div v-else-if="userType !== 'admin'" class="access-denied">
            <p>{{ t('admin_only') }} ({{ userType }})</p>
            <p class="wallet-info-small">{{ shortAddress }}</p>
          </div>

          <template v-else>
            <wallet-header :address="address" :user-type="userType" setting-base="index.html"></wallet-header>

            <div v-if="error" class="error-message">{{ error }}</div>
            <div v-if="success" class="success-message">{{ success }}</div>

            <!-- Config Diff Alert -->
            <div v-if="configDiffs.length > 0" class="diff-alert">
              <h3>{{ t('config_diff_title') }}</h3>
              <div v-for="(d, i) in configDiffs" :key="i" class="diff-item">
                <span class="diff-badge" :class="d.type">{{ d.type === 'config_only' ? t('config_only_label') : t('manager_only_label') }}</span>
                <span class="mono" style="font-size:12px;">{{ d.address.slice(0,6) + '...' + d.address.slice(-4) }}</span>
                <span>{{ d.name }} ({{ d.entryType }})</span>
                <span style="opacity:0.6; font-size:12px;">{{ d.type === 'config_only' ? t('config_only_msg') : t('manager_only_msg') }}</span>
              </div>
            </div>

            <!-- コントラクト一覧 -->
            <div class="section-card">
              <h2 class="section-heading">{{ t('contract_list') }}</h2>
              <div v-if="loading" class="loading-center"><span class="loading-spinner"></span></div>
              <table v-else class="data-table">
                <thead>
                  <tr><th>{{ t('address') }}</th><th>{{ t('name_label') }}</th><th>{{ t('type_label') }}</th><th>{{ t('visible') }}</th><th></th></tr>
                </thead>
                <tbody>
                  <tr v-for="c in contracts" :key="c.address" :class="{ 'row-hidden': !c.visible }">
                    <td class="mono addr-cell">
                      <a :href="CONFIG.chain.explorer + '/address/' + c.address" target="_blank" class="link">{{ shortAddr(c.address) }}</a>
                    </td>
                    <td>{{ c.name }}</td>
                    <td><span class="type-badge">{{ c.type }}</span></td>
                    <td>
                      <span v-if="c.visible" class="badge-visible">{{ t('visible') }}</span>
                      <span v-else class="badge-hidden">{{ t('hidden') }}</span>
                    </td>
                    <td class="actions">
                      <button class="btn btn-sm" @click="startEdit(c)">{{ t('edit') }}</button>
                      <button v-if="c.visible" class="btn btn-sm" @click="toggleContract(c, false)" :disabled="sending">{{ t('hidden') }}</button>
                      <button v-else class="btn btn-sm" @click="toggleContract(c, true)" :disabled="sending">{{ t('visible') }}</button>
                      <button class="btn btn-sm btn-danger" @click="removeContract(c)" :disabled="sending">{{ t('remove') }}</button>
                    </td>
                  </tr>
                  <tr v-if="contracts.length === 0"><td colspan="5" class="empty">{{ t('no_contracts') }}</td></tr>
                </tbody>
              </table>
            </div>

            <!-- 追加 / 編集 -->
            <div class="section-card">
              <h2 class="section-heading">{{ editMode ? t('edit_contract') : t('add_contract') }}</h2>
              <div class="form-grid">
                <div class="form-field">
                  <label>{{ t('address') }}</label>
                  <input type="text" v-model="form.address" class="form-input mono" placeholder="0x..." :disabled="editMode" />
                </div>
                <div class="form-field">
                  <label>{{ t('name_label') }}</label>
                  <input type="text" v-model="form.name" class="form-input" :placeholder="t('contract_name_placeholder')" />
                </div>
                <div class="form-field">
                  <label>{{ t('type_label') }}</label>
                  <select v-model="form.type" class="form-input">
                    <option value="nft">nft</option>
                    <option value="sbt">sbt</option>
                    <option value="tba">tba</option>
                    <option value="donate">donate</option>
                    <option value="other">other</option>
                  </select>
                </div>
              </div>
              <div class="form-actions">
                <button class="btn btn-primary" @click="submitContract" :disabled="!form.address || !form.name || sending">
                  {{ editMode ? t('update') : t('add') }}
                </button>
                <button v-if="editMode" class="btn" @click="cancelEdit">{{ t('cancel') }}</button>
              </div>
            </div>

            <div class="manager-info">
              Manager: <a :href="CONFIG.chain.explorer + '/address/' + CONFIG.contracts.manager.address" target="_blank" class="mono link">{{ CONFIG.contracts.manager.address }}</a>
            </div>
          </template>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            connected: false, connecting: false, sending: false, loading: false,
            error: null, success: null,
            address: null,
            userType: 'none',
            contracts: [],
            configDiffs: [],
            form: { address: '', name: '', type: 'nft' },
            editMode: false,
            menuOpen: false,
            CONFIG,
          };
        },
        computed: {
          homeUrl() { return (window.i18n ? window.i18n.contentBase() : "../../ja") + "/index.html"; },
          metamaskAvailable() { return Wallet.isAvailable(); },
          shortAddress() { return Wallet.shortAddress(); },
          lang() { return (window.i18n && window.i18n.currentLang) || new URLSearchParams(location.search).get('lang') || 'ja'; },
        },
        async mounted() {
          const r = await Wallet.reconnect();
          if (r) { this.connected = true; this.address = Wallet.getAddress(); await this.init(); }
          if (window.i18n) { window.i18n.apply(); }
        },
        methods: {
          t(key) { return window.i18n ? window.i18n.t(key) : key; },
          toggleMenu() { this.menuOpen = !this.menuOpen; document.body.style.overflow = this.menuOpen ? 'hidden' : ''; },
          closeMenu() { this.menuOpen = false; document.body.style.overflow = ''; },
          async connectWallet() {
            this.connecting = true;
            try {
              await Wallet.connect();
              await Wallet.ensurePolygon();
              this.connected = true;
              this.address = Wallet.getAddress();
              await this.init();
            } catch (e) { this.error = e.message; }
            this.connecting = false;
          },
          async init() {
            this.loading = true;
            this.userType = await Manager.checkUser();
            if (this.userType === 'admin') {
              this.contracts = await Manager.getAllContracts();
              this.checkConfigDiff();
            }
            this.loading = false;
          },

          checkConfigDiff() {
            const diffs = [];
            const managerAddrs = new Set(this.contracts.map(c => c.address.toLowerCase()));

            // config.jsにあってManagerにないもの
            const configEntries = [
              ...CONFIG.contracts.nfts.map(n => ({ address: n.address, name: n.name, type: 'nft', source: 'config.nfts' })),
            ];
            if (CONFIG.contracts.sbt?.address) {
              configEntries.push({ address: CONFIG.contracts.sbt.address, name: 'SBT', type: 'sbt', source: 'config.sbt' });
            }

            for (const entry of configEntries) {
              if (!managerAddrs.has(entry.address.toLowerCase())) {
                diffs.push({ type: 'config_only', address: entry.address, name: entry.name, entryType: entry.type });
              }
            }

            // Managerにあってconfigにないもの (nft/sbt type only)
            const configAddrs = new Set(configEntries.map(e => e.address.toLowerCase()));
            for (const c of this.contracts) {
              if ((c.type === 'nft' || c.type === 'sbt') && c.visible && !configAddrs.has(c.address.toLowerCase())) {
                diffs.push({ type: 'manager_only', address: c.address, name: c.name, entryType: c.type });
              }
            }

            this.configDiffs = diffs;
          },
          shortAddr(a) { return a ? a.slice(0,6) + '...' + a.slice(-4) : ''; },
          startEdit(c) {
            this.form = { address: c.address, name: c.name, type: c.type };
            this.editMode = true;
          },
          cancelEdit() {
            this.form = { address: '', name: '', type: 'nft' };
            this.editMode = false;
          },
          async submitContract() {
            this.sending = true; this.error = null; this.success = null;
            try {
              if (this.editMode) {
                await Manager.setContractInfo(this.form.address, this.form.name, this.form.type);
                this.success = this.t('contract_updated');
              } else {
                await Manager.setContract(this.form.address, this.form.name, this.form.type);
                this.success = this.t('contract_added');
              }
              this.cancelEdit();
              this.contracts = await Manager.getAllContracts();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
          async toggleContract(c, visible) {
            this.sending = true; this.error = null; this.success = null;
            try {
              if (visible) { await Manager.publicContract(c.address); }
              else { await Manager.hiddenContract(c.address); }
              this.success = visible ? this.t('contract_public') : this.t('contract_hidden_done');
              this.contracts = await Manager.getAllContracts();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
          async removeContract(c) {
            if (!confirm(c.name + ' (' + c.address + ')' + this.t('confirm_delete_contract'))) return;
            this.sending = true; this.error = null; this.success = null;
            try {
              await Manager.deleteContract(c.address);
              this.success = this.t('contract_deleted');
              this.contracts = await Manager.getAllContracts();
            } catch (e) { this.error = e.message; }
            this.sending = false;
          },
        },
      }).component('wallet-header', WalletHeader).mount('#app');
    </script>
</body>
</html>
